<script>
    const label  = document.querySelector('.label')
    const config = []
  
    // ============ Script ===============================
    google.script.run.withSuccessHandler(topList).loadConfigurations()
    google.script.run.withSuccessHandler(asideItem).getAsideList(label.innerText)
  
  
  
    function topActiv(){
      const elememt = document.querySelectorAll('.main__services-item')
  
      for(let i=0; i < elememt.length; i++){
        elememt[i].classList.remove('main__services-item-activ')
        if(elememt[i].innerText.includes(label.innerText)){
          elememt[i].classList.add('main__services-item-activ')
        }
      }
  
    }
  
    function topList(el){
      const elememt = document.querySelector('.main__services-items')
      for(let item in el){
        if(el[item].title == label.innerText) {
          config.push(el[item])
        }
      }
      el.forEach( (item,indexOf) =>{
        const main__services__item = `
            <a href="https://script.google.com/macros/s/AKfycbzNWg-s1JdkHPFJX8IA4CW8CwQQphFszDiWlSj6LBw/dev?v=${indexOf}"  class="main__services-item">
              <p>${item.title}</p>
              <p>${item.data}</p>
            </a>
          `
        elememt.insertAdjacentHTML('beforeend',main__services__item)
  
      })
      topActiv()
      return google.script.run.withSuccessHandler(chart).generateChartElements(label.innerText)
    }
  
  
  
  
  
  
  // =====================  List Filter =============
    function filterList (sortList,htmlElement,colorElement,addClass) {
      const element_min = document.querySelector(htmlElement)
      sortList.map( item =>{
        const el = `
            <div class="dinamik__bottom-item">
                <div class="dinamik__bottom-info">
                    <h5>${item[0]}</h5>
                    <span>${item[1]}</span>
                </div>
                <progress class="${addClass}"  max="${config[0].max}" value="${item[1]}"></progress>
            </div>
          `
        element_min.insertAdjacentHTML('beforeend',el)
        const style = document.createElement('style');
        style.innerHTML = `
              .${addClass}::-webkit-progress-value {
                    background: ${colorElement};
                }
          `;
          document.head.appendChild(style);
      })
      return;
    }
  
    function listerDinamik(listerChart) {
      const btn_lister = document.querySelectorAll('.btn-school')
      const minList = listerChart.filter(item => parseInt(item[1]) < config[0].min)
      const srtList = listerChart.filter(item => parseInt(item[1]) >= config[0].min && parseInt(item[1]) <= config[0].max)
      const maxList = listerChart.filter(item => parseInt(item[1]) > config[0].max)
  
      filterList(minList,'.dinamik__bottom-min',config[0].minColor,'srt__progress-min');
      filterList(srtList,'.dinamik__bottom-srt',"#ffff00",'srt__progress-srt');
      filterList(maxList,'.dinamik__bottom-max',config[0].maxColor,'srt__progress-max');
  
  
      for(let i=0; i < btn_lister.length; i++){
        btn_lister[i].addEventListener('click',()=>{
          for(let i=0; i < btn_lister.length; i++){
            btn_lister[i].classList.remove("btn-school-activ");
            document.querySelector(".dinamik__bottom-min").style.display = 'none'
            document.querySelector(".dinamik__bottom-srt").style.display = 'none'
            document.querySelector(".dinamik__bottom-max").style.display = 'none'
          }
          const getClass = `.dinamik__bottom-${btn_lister[i].id.split('__')[0]}`
          document.querySelector(getClass).style.display = 'block'
          btn_lister[i].classList.add('btn-school-activ')
        })
      }
      return dinamiRight(config)
    }
  
  
  //  =========== INFO CONFIG ===================
  
    function dinamiRight(config){
      document.querySelector('.dinamik__maps-title-T').innerHTML = config[0].title
      document.querySelector('.dinamik__maps-min-count').innerHTML = config[0].min
      document.querySelector('.dinamik__maps-max-count').innerHTML = config[0].max
      document.querySelector('.dinamik__maps-data-count').innerHTML = config[0].data
    }
  // ============ TABLE ===============================
  
    function table_style(lister){
  
      const table_td = document.querySelectorAll('td')
          
      let listerTD = []
      let count = 0;
      let sps = []
  
  
      for(let i=0;  i <= table_td.length ; i++){
        if(count == config[0].len){
          count = 0
          listerTD.push(sps)
          sps = []
        }
        sps.push(table_td[i])
          count += 1
      }
  
  
      listerTD.forEach(item =>{
        item.slice(1).filter((el,index) => {
          if(!lister.includes(index)){
            if(parseInt(el.innerText) < config[0].min){
              el.style.backgroundColor = config[0].minColor
            }
            else if(parseInt(el.innerText) >= config[0].min && parseInt(el.innerText) <= config[0].max ){
              el.style.backgroundColor= '#FFB700'
            }
            else if(parseInt(el.innerText) > config[0].max){
              el.style.backgroundColor= config[0].maxColor
            }
          }
        })
      })
          
    }
  
  // ============  CHART  ============================
    function chart(listerChart){
  
      const ctx = document.getElementById('myChart');
      Chart.defaults.font.size = 9
      Chart.defaults.color = '#FFF'
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [
              ...listerChart.map(item => item[0])
          ],
          datasets: [{
            data: [...listerChart.map(item => item[1])
            ],
            backgroundColor:function(context) {
              var value = context.dataset.data[context.dataIndex];
              if(value < config[0].min){
                return config[0].minColor
              }else if(value >= config[0].min && value <= config[0].max){
                return 'yellow'
              }else if(value > config[0].max){
                return config[0].maxColor
              }
            },
            borderWidth: 1,
            borderSkipped: false,
            borderRadius:'5',
          }]
        },
        options: {
          responsive: false,
          plugins:{
            legend:{
              display:false,
            },
            
          },
          scales: {
          y: {
              grid: {
                  display: false // Убираем сетку по оси Y
              }
          },
          x: {
              grid: {
                  display: false // Убираем сетку по оси X
              }
          }
        }
          
        }
      })
  
      listerDinamik(listerChart)
      return google.script.run.withSuccessHandler(table_style).tableLister(label.innerText)
    }
  
  //  ============= SCRIPT ELEMET ====================
    function asideItem(asides){
      for (let i = 0; i < asides.length; i++) {
        const item = `
                      <div class="aside__item">
                          <div class="aside__link">
                              <span class="--styl">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#222" class="bi bi-book-fill" viewBox="0 0 16 16">
                                    <path d="M8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783"/>
                                  </svg>
                              </span>
                              <span class="aside__link-name">${asides[i]}</span>
                          </div>
                      </div>
                    `
      document.querySelector(".aside__lister").insertAdjacentHTML('beforeend',item)
      }
  
      return  modalClick()
    }
  
  
  
    function scrollChart(){
      let container = document.querySelectorAll('#scrollDown');
      let isDown = false;
      let startX;
      let scrollLeft;
  
      for(let i=0; i < container.length; i++){
          container[i].addEventListener('mousedown', function (e) {
              isDown = true;
              startX = e.pageX - container[i].offsetLeft;
              scrollLeft = container[i].scrollLeft;
          });
  
          container[i].addEventListener('mouseleave', function () {
              isDown = false;
          });
  
          container[i].addEventListener('mouseup', function () {
              isDown = false;
          });
  
          container[i].addEventListener('mousemove', function (e) {
              if (!isDown) return;
              e.preventDefault();
              let x = e.pageX - container[i].offsetLeft;
              let walk = (x - startX) * 0.9;
              container[i].scrollLeft = scrollLeft - walk;
          });
      }
  
    }
  
  
  
    function modalClick(){
      let modal = document.querySelector(".modal");
      let items = document.querySelectorAll(".aside__item");
      let closeBTN = document.querySelector(".btn-modal");
  
      for (let i = 0; i < items.length; i++) {
        items[i].addEventListener('click',()=>{
          document.querySelector('.container__loding').style.display = 'block'
          const title = document.querySelector('.modal__content-title')
          title.innerHTML = items[i].querySelector('.aside__link-name').innerText
  
          let ulListerDIV = document.querySelector('.modal__content-lister')
          let ulListerArray = document.querySelector('.modal__content-lister-children')
          ulListerDIV.removeChild(ulListerArray)
  
          google.script.run.withSuccessHandler(modalChart).populateModalInformation(items[i].querySelector('.aside__link-name').innerText)
          modal.style.display = "flex";
        })
        
      }
      
      closeBTN.onclick = function() {
        modal.style.display = "none";
      }
      
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
      
    }
  
  
  
    function modalChart(infoList) {
      let ulListerDIV = document.querySelector('.modal__content-lister')
      let ulListerArray = document.createElement('div')
      ulListerArray.className = 'modal__content-lister-children'
      ulListerDIV.appendChild(ulListerArray)
      
      for (let i = 0; i < infoList.length; i++) {
  
        const item = `
          <li class="modal__content-item">
              <div class="modal__content-canvas">
                  <div class="modal__content-chart">
                    <canvas id="linearChart-${i}" width="90" height="90"></canvas>
                    <p class="modal__content-count">${infoList[i].count}</p>
                </div>
                <div class="modal__content-name">${infoList[i].title}</div>
              </div>
              <div class="modal__content-special">
                  <div class="--liner"></div>
              </div>
              <div class="modal__content-data">
                ${infoList[i].data}
              </div>
          </li>
        `
        ulListerArray.insertAdjacentHTML('beforeend',item)
        const linearChart = document.getElementById(`linearChart-${i}`);
          
        const data = {
                labels: [
                  infoList[i].title,
                  'Blue',
                ],
                datasets: [{
                  data: [infoList[i].max, infoList[i].min],
                  backgroundColor: [
                    "#222",
                    "#FFF",
                  ],
                  hoverOffset: 1,
                  borderWidth:1,
                }]
            };
  
            new Chart(linearChart, {
              type: 'doughnut',
              data: data,
              options: {
                responsive: false,
                plugins:{
                  legend:{
                    display:false,
                  },
                  
                }
                
              }
        }) 
  
      }
      document.querySelector('.container__loding').style.display = 'none'
  
    }
  
    scrollChart()
  
  </script>